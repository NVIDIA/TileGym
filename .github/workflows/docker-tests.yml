name: tilegym-build-and-test

on:
  push:
    branches:
      - main
      - "pull-request/[0-9]+"

env:
  IMAGE_NAME: tilegym-transformers

jobs:
  config:
    name: parse-ci-config
    runs-on: ubuntu-latest
    outputs:
      build: ${{ steps.parse.outputs.build }}
      run_ops: ${{ steps.parse.outputs.run_ops }}
      run_benchmark: ${{ steps.parse.outputs.run_benchmark }}
      image_tag: ${{ steps.parse.outputs.image_tag }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Get PR info
        id: pr
        uses: actions/github-script@v7
        with:
          script: |
            let prBody = '';
            let prNumber = '';
            if (context.eventName === 'pull_request') {
              prBody = context.payload.pull_request.body || '';
              prNumber = context.payload.pull_request.number.toString();
            }
            return { prBody, prNumber };

      - name: Parse config
        id: parse
        env:
          PR_BODY: ${{ fromJSON(steps.pr.outputs.result).prBody }}
          PR_NUMBER: ${{ fromJSON(steps.pr.outputs.result).prNumber }}
        run: |
          pip install pyyaml --quiet
          python3 .github/scripts/parse_pr_config.py
          
          # Set image tag based on context
          if [ -n "$PR_NUMBER" ]; then
            echo "image_tag=pr-${PR_NUMBER}" >> $GITHUB_OUTPUT
          else
            echo "image_tag=latest" >> $GITHUB_OUTPUT
          fi

  build:
    name: build-tilegym-transformers-image
    needs: config
    if: needs.config.outputs.build == 'true'
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set image variables
        id: vars
        run: |
          OWNER_LOWER=$(echo '${{ github.repository_owner }}' | tr '[:upper:]' '[:lower:]')
          REGISTRY_IMAGE="ghcr.io/${OWNER_LOWER}/${{ env.IMAGE_NAME }}"
          
          echo "registry_image=${REGISTRY_IMAGE}" >> $GITHUB_OUTPUT

      - name: Free up disk space
        run: |
          sudo rm -rf /usr/share/dotnet
          sudo rm -rf /usr/local/lib/android
          sudo rm -rf /opt/ghc
          sudo rm -rf /opt/hostedtoolcache/CodeQL
          docker system prune -af
          df -h

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Login to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Build and push Docker image to GHCR
        uses: docker/build-push-action@v5
        with:
          context: .
          file: ./modeling/transformers/Dockerfile
          tags: |
            ${{ steps.vars.outputs.registry_image }}:${{ needs.config.outputs.image_tag }}
            ${{ steps.vars.outputs.registry_image }}:${{ github.sha }}
          push: true
          cache-from: type=gha
          cache-to: type=gha,mode=max

  test-ops:
    name: test-ops
    needs: [config, build]
    if: |
      always() && 
      needs.config.outputs.run_ops == 'true' &&
      (needs.build.result == 'success' || needs.build.result == 'skipped')
    runs-on: linux-amd64-gpu-rtxpro6000-latest-1
    steps:
      - name: Login to GHCR
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Pull and run ops tests
        run: |
          OWNER_LOWER=$(echo '${{ github.repository_owner }}' | tr '[:upper:]' '[:lower:]')
          IMAGE="ghcr.io/${OWNER_LOWER}/${{ env.IMAGE_NAME }}:${{ needs.config.outputs.image_tag }}"
          
          docker pull ${IMAGE}
          docker run --rm \
            --gpus all \
            -w /workspace/tilegym \
            ${IMAGE} \
            pytest -s tests/ops -v -k test_op

  test-benchmark:
    name: test-benchmark
    needs: [config, build]
    if: |
      always() && 
      needs.config.outputs.run_benchmark == 'true' &&
      (needs.build.result == 'success' || needs.build.result == 'skipped')
    runs-on: linux-amd64-gpu-rtxpro6000-latest-1
    steps:
      - name: Login to GHCR
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Pull and run benchmarks
        run: |
          OWNER_LOWER=$(echo '${{ github.repository_owner }}' | tr '[:upper:]' '[:lower:]')
          IMAGE="ghcr.io/${OWNER_LOWER}/${{ env.IMAGE_NAME }}:${{ needs.config.outputs.image_tag }}"
          
          docker pull ${IMAGE}
          docker run --rm \
            --gpus all \
            -w /workspace/tilegym/tests/benchmark \
            ${IMAGE} \
            ./run_all.sh --parallel
